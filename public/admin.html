<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç†</title>
    <link rel="stylesheet" href="static/style.css">
    <style>
        .table-row { display: flex; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; }
        .table-col { flex: 1; padding: 0 5px; }
        .inp-sm { width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card header">
        <h3>ç®¡ç†åå°</h3>
        <a href="index.html" style="font-size:14px;">è¿”å›å‰å°</a>
    </div>

    <div id="admin-login" class="card hidden">
        <p>è¯·å…ˆåœ¨å‘˜å·¥ç«¯ç™»å½•ç®¡ç†å‘˜è´¦å· (13800138000 / admin123)</p>
        <a href="index.html" class="btn btn-primary">å»ç™»å½•</a>
    </div>

    <div id="admin-panel">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('users')">ç”¨æˆ·å®¡æ ¸</div>
            <div class="tab" onclick="switchTab('recharge')">è´¢åŠ¡å……å€¼</div>
            <div class="tab hidden" id="tab-nav-settings" onclick="switchTab('settings')">ä»·æ ¼è®¾ç½®</div>
        </div>

        <div id="tab-users">
            <div class="card">
                <input type="text" id="user-kw" placeholder="æœç´¢æ‰‹æœºå·æˆ–å§“å..." onchange="loadUsers()">
                <div style="margin-bottom:10px;">
                    <button class="btn" style="width:auto; background:#eee; color:#333" onclick="loadUsers('0')">åªçœ‹å¾…å®¡æ ¸</button>
                    <button class="btn" style="width:auto; background:#eee; color:#333" onclick="loadUsers()">å…¨éƒ¨</button>
                </div>
                <div id="user-list"></div>
            </div>
        </div>

        <div id="tab-recharge" class="hidden">
            <div class="card">
                <h4>äººå·¥å……å€¼</h4>
                <div style="background:#fff3cd; color:#856404; padding:10px; font-size:12px; margin-bottom:10px; border-radius:4px;">
                    æ³¨æ„ï¼šæ¶‰åŠé‡‘é¢æ“ä½œï¼Œè¯·åŠ¡å¿…æ ¸å¯¹ç”¨æˆ·ä¿¡æ¯ã€‚
                </div>
                <input type="text" id="rc-uid" placeholder="è¾“å…¥ç”¨æˆ· ID (ä»ç”¨æˆ·åˆ—è¡¨æŸ¥çœ‹)">
                <input type="number" id="rc-amount" placeholder="å……å€¼é‡‘é¢ (å…ƒ)">
                <button class="btn btn-success" onclick="doRecharge()">ç¡®è®¤å……å€¼</button>
            </div>
            <div class="card">
                <h4>æœ€è¿‘å……å€¼è®°å½•</h4>
                <div id="rc-logs" style="font-size:12px;"></div>
            </div>
        </div>

        <div id="tab-settings" class="hidden">
            <div class="card">
                <h4>ğŸ± ä»·æ ¼ä½“ç³»è®¾ç½®</h4>
                <p style="font-size:12px; color:#666; margin-bottom:10px;">ä¿®æ”¹åå³æ—¶ç”Ÿæ•ˆï¼Œä¸å½±å“å†å²è®¢å•ã€‚</p>
                <div id="level-list">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
</div>

<script src="static/app.js"></script>
<script>
    let currentRole = '';

    (async function init() {
        const res = await request('/user/info.php');
        if (!res || res.code !== 0 || (res.data.role !== 'admin' && res.data.role !== 'finance')) {
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('admin-login').classList.remove('hidden');
        } else {
            currentRole = res.data.role;
            if (currentRole === 'admin') {
                document.getElementById('tab-nav-settings').classList.remove('hidden');
            }
            loadUsers('0'); 
            loadRechargeLogs();
            if (currentRole === 'admin') loadSettings();
        }
    })();

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('tab-users').classList.add('hidden');
        document.getElementById('tab-recharge').classList.add('hidden');
        document.getElementById('tab-settings').classList.add('hidden');
        document.getElementById('tab-' + tab).classList.remove('hidden');
    }

    // --- ç”¨æˆ·ç®¡ç† ---
    async function loadUsers(status = '') {
        const kw = document.getElementById('user-kw').value;
        const res = await request(`/admin/users.php?keyword=${kw}&status=${status}`);
        if (res.code !== 0) return;

        const list = document.getElementById('user-list');
        list.innerHTML = res.data.length ? '' : '<p style="text-align:center;color:#999">æš‚æ— æ•°æ®</p>';

        res.data.forEach(u => {
            const statusText = u.status == 0 ? '<span style="color:red">å¾…å®¡æ ¸</span>' : (u.status == 1 ? '<span style="color:green">æ­£å¸¸</span>' : 'ç¦ç”¨');
            const actionBtn = u.status == 0 
                ? `<button onclick="auditUser(${u.id}, 'approve')" style="color:green; border:1px solid green; background:none; padding:2px 5px; border-radius:3px;">é€šè¿‡</button>` 
                : '';
            
            let roleBtn = '';
            if (currentRole === 'admin') {
                if (u.role === 'user') {
                    roleBtn = `<button onclick="setRole(${u.id}, 'finance')" style="margin-left:5px; color:#fff; background:#17a2b8; border:none; padding:2px 5px; border-radius:3px;">è®¾ä¸ºè´¢åŠ¡</button>`;
                } else if (u.role === 'finance') {
                    roleBtn = `<button onclick="setRole(${u.id}, 'user')" style="margin-left:5px; color:#666; background:#eee; border:none; padding:2px 5px; border-radius:3px;">é™ä¸ºæ™®é€š</button>`;
                } else if (u.role === 'admin') {
                    roleBtn = `<span style="margin-left:5px; color:#6610f2; font-weight:bold; font-size:12px;">è¶…çº§ç®¡ç†å‘˜</span>`;
                }
            }

            list.innerHTML += `
                <div class="menu-item" style="font-size:14px;">
                    <div>
                        <div><strong>${u.name}</strong> <small>(${u.phone})</small></div>
                        <div style="color:#666; font-size:12px;">ID:${u.id} | ${u.dept_name} | ä½™é¢: ${formatMoney(u.amount)}</div>
                    </div>
                    <div style="text-align:right">
                        <div>${statusText}</div>
                        <div style="margin-top:5px;">${actionBtn}${roleBtn}</div>
                    </div>
                </div>`;
        });
    }

    async function auditUser(id, action) {
        if (!confirm('ç¡®è®¤æ“ä½œå—ï¼Ÿ')) return;
        const res = await request('/admin/users.php', 'POST', { id, action });
        if (res.code === 0) { toast('æ“ä½œæˆåŠŸ'); loadUsers(); }
        else alert(res.msg);
    }

    async function setRole(id, role) {
        if (!confirm('ç¡®å®šä¿®æ”¹æƒé™å—ï¼Ÿ')) return;
        const res = await request('/admin/users.php', 'POST', { id, action: 'change_role', role });
        if (res.code === 0) { toast('æ“ä½œæˆåŠŸ'); loadUsers(); }
        else alert(res.msg);
    }

    // --- å……å€¼ ---
    async function doRecharge() {
        const uid = document.getElementById('rc-uid').value;
        const amt = document.getElementById('rc-amount').value;
        if (!uid || !amt) return alert('è¯·å¡«å†™å®Œæ•´');
        if (!confirm(`ç¡®è®¤å……å€¼ ${amt} å…ƒå—ï¼Ÿ`)) return;

        const res = await request('/finance/recharge.php', 'POST', { user_id: uid, amount: amt });
        if (res.code === 0) {
            alert(res.msg);
            document.getElementById('rc-uid').value = '';
            document.getElementById('rc-amount').value = '';
            loadRechargeLogs();
        } else {
            alert(res.msg);
        }
    }

    async function loadRechargeLogs() {
        const res = await request('/finance/logs.php');
        if (res.code === 0) {
            document.getElementById('rc-logs').innerHTML = res.data.map(l => 
                `<div style="padding:5px 0; border-bottom:1px dashed #eee;">
                    ${l.created_at} - <strong>${l.user_name}</strong> å……å€¼ Â¥${formatMoney(l.amount)}
                 </div>`
            ).join('');
        }
    }

    // --- ä»·æ ¼è®¾ç½® ---
    async function loadSettings() {
        const res = await request('/admin/settings.php');
        if (res.code !== 0) return;

        const levelsDiv = document.getElementById('level-list');
        levelsDiv.innerHTML = `
            <div class="table-row" style="background:#f8f9fa; font-weight:bold; font-size:12px;">
                <div class="table-col" style="flex:1">ç­‰çº§åç§°</div>
                <div class="table-col" style="flex:1">ä¸­é¤(å…ƒ)</div>
                <div class="table-col" style="flex:1">æ™šé¤(å…ƒ)</div>
                <div class="table-col" style="flex:0.8; text-align:right">æ“ä½œ</div>
            </div>
        `;
        res.data.levels.forEach(l => {
            levelsDiv.innerHTML += `
                <div class="table-row">
                    <div class="table-col">${l.name}</div>
                    <div class="table-col"><input type="number" class="inp-sm" id="p-lunch-${l.id}" value="${l.price_lunch/100}"></div>
                    <div class="table-col"><input type="number" class="inp-sm" id="p-dinner-${l.id}" value="${l.price_dinner/100}"></div>
                    <div class="table-col" style="text-align:right">
                        <button class="btn btn-primary" style="padding:4px 8px; width:auto; font-size:12px;" onclick="savePrice(${l.id})">ä¿å­˜</button>
                    </div>
                </div>
            `;
        });
    }

    async function savePrice(id) {
        const pLunch = document.getElementById(`p-lunch-${id}`).value;
        const pDinner = document.getElementById(`p-dinner-${id}`).value;
        const data = {
            action: 'update_price',
            id: id,
            price_lunch: Math.round(pLunch * 100),
            price_dinner: Math.round(pDinner * 100)
        };
        const res = await request('/admin/settings.php', 'POST', data);
        if (res.code === 0) toast('ä»·æ ¼å·²æ›´æ–°');
        else alert(res.msg);
    }
</script>
</body>
</html>